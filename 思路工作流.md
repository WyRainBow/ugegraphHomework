## Apache HugeGraph 项目整体思路总结

### 核心目标
自动生成 Apache HugeGraph 毕业文章，包含投票统计分析和文章内容生成。

### 整体设计思路

**1. 统一架构设计**
- 采用统一的 LLM 调用接口，提供一致的调用体验
- 使用分阶段工作流模式，每个阶段职责明确
- 采用模块化设计，各模块独立、可测试

**2. 两阶段分离设计**
- 阶段一：投票分析（独立执行）
  - 从 Apache 邮件列表获取投票数据
  - 提取投票信息（谁投了什么票、是否绑定票）
  - 统计并格式化输出
  - 可单独运行，不依赖其他阶段
- 阶段二：文章生成（主流程）
  - 基于投票分析结果生成文章
  - 包含封面图、正文、图表、链接等
  - 可复用已有数据，支持离线运行



### 工作流程简述

**第一步：投票分析**
- 从 Apache 邮件列表获取投票数据
- 用正则或 LLM 提取投票信息
- 统计并格式化输出

**第二步：文章生成**
- 生成封面图（可选，失败不影响）
- 加载项目信息和投票统计
- 用 LLM 生成大纲和正文（2000-3000 字）
- 从投票邮件中提取引用金句
- 生成数据可视化图表
- 替换所有占位符为实际内容
- 保存最终文章

### 设计优势

1. 可测试性：每个阶段可独立测试
2. 可维护性：模块清晰，职责明确
3. 可扩展性：新增步骤只需修改工作流
4. 健壮性：完善的错误处理，不会因单个步骤失败而崩溃
5. 灵活性：支持使用已有数据，支持跳过可选步骤

### 核心思想

**分阶段执行 + 容错设计 + 占位符机制 + 数据驱动**

- 分阶段执行：每个阶段有明确输入输出，便于调试和优化
- 容错设计：关键步骤失败中断，非关键步骤失败继续
- 占位符机制：延迟替换，确保路径正确
- 数据驱动：优先使用已有数据，减少重复计算

整体思路是：通过统一架构、分阶段执行、容错设计、占位符机制、数据驱动等设计，实现从原始数据到完整文章的自动化生成。

---

## 子流程/子工具设计思路

### 核心设计理念

**统一 LLM 调用 + 子流程封装**

整个项目的设计思路是：
1. **统一的 LLM 调用接口**：所有 LLM 调用都通过统一接口，提供一致的调用方式
2. **子流程/子工具封装**：针对文章的各个部分，封装成独立的子流程或工具

### 子流程设计

文章生成的各个部分都被封装成独立的子流程：

**1. 大纲生成子流程**
- 输入：主题、需求
- 处理：调用统一 LLM 接口生成文章大纲
- 输出：结构化的大纲数据
- 特点：使用保守模式，确保结构准确

**2. 正文生成子流程**
- 输入：主题、项目信息、投票统计
- 处理：调用统一 LLM 接口生成文章正文
- 输出：包含标题、描述、正文内容的结构化数据
- 特点：使用平衡模式，自动设置足够的输出长度

**3. 引用提取子流程**
- 输入：投票邮件数据
- 处理：调用统一 LLM 接口提取正面评价
- 输出：格式化的引用列表
- 特点：有降级策略（LLM 失败时用正则提取）

**4. 数据可视化子流程**
- 生成社区趋势图
- 生成版本时间线
- 生成投票分布图
- 特点：不依赖 LLM，使用图表库生成

**5. 链接收集子流程**
- 输入：链接配置文件
- 处理：格式化链接数据
- 输出：格式化的链接列表
- 特点：纯数据处理，不调用 LLM

**6. 投票分析子流程**
- 数据获取：从 API 获取投票数据
- 投票提取：正则优先，LLM 辅助
- 数据统计：按类型分组统计
- 特点：独立执行，可单独运行

### 子流程组合

主工作流将这些子流程组合起来：

```
主工作流
  ├─ 封面图生成（可选）
  ├─ 文章生成主流程
  │   ├─ 大纲生成子流程
  │   ├─ 正文生成子流程
  │   └─ 引用提取子流程
  ├─ 数据可视化子流程（3个图表）
  ├─ 链接收集子流程
  └─ 占位符替换（整合所有内容）
```

### 设计优势

**1. 模块化**
- 每个子流程职责单一，易于理解和维护
- 可以独立测试每个子流程

**2. 可复用**
- 子流程可以在不同场景下复用
- 例如：引用提取功能可以用于其他文章类型

**3. 可扩展**
- 新增功能只需添加新的子流程
- 不影响现有流程

**4. 统一接口**
- 所有 LLM 调用都通过统一接口，调用方式一致
- 便于统一管理和优化

**5. 灵活组合**
- 主工作流可以灵活组合不同的子流程
- 可以根据需求选择执行哪些子流程

### 子流程 vs 工具

在这个项目中，子流程和工具的概念是统一的：
- **子流程**：从工作流角度，是一个独立的处理步骤
- **工具**：从功能角度，是一个可调用的工具函数

例如：
- 大纲生成既是一个子流程，也是一个工具
- 引用提取既是一个子流程，也是一个工具

这种设计让代码既符合工作流思维，又符合工具化思维。

---

## LLM 调用接口设计

### 统一 LLM 调用接口设计思路

统一 LLM 调用接口是项目的核心，设计目标是提供统一、灵活、易用的 LLM 调用方式。

### 接口参数设计

接口包含以下参数：
- 任务类别：用于标识任务类型（如创建、分析等）
- 任务类型：用于标识具体任务（如内容写作、大纲生成等）
- 任务摘要：简要描述任务目标
- 任务指令：主要的提示词内容（必需）
- 输入数据：结构化的输入数据
- 输出格式：控制输出格式，支持结构化输出
- 处理上下文：额外的上下文信息
- 创造力级别：控制输出风格（保守、平衡、创造性）
- 图片源：支持图片输入（多模态）

### 设计要点

**1. 参数分类设计**
- **任务描述参数**：任务类别、任务类型、任务摘要 - 用于构建系统消息，告诉模型任务类型
- **核心内容参数**：任务指令 - 主要的提示词内容，必需参数
- **数据参数**：输入数据 - 结构化数据，自动格式化为 JSON 添加到提示词中
- **输出控制参数**：输出格式 - 控制输出格式，支持结构化输出
- **行为控制参数**：创造力级别 - 控制温度，影响输出风格
- **扩展参数**：图片源 - 支持多模态输入（图片理解）

**2. 消息构建逻辑**

系统消息构建：
- 基础：助手角色设定
- 添加处理上下文（如果有）
- 添加任务类别和类型（用于明确任务方向）
- 特殊处理：文章生成任务自动添加字数要求强调

用户消息构建：
- 核心：任务指令（主要提示词）
- 如果有输入数据，自动格式化为 JSON 并追加
- 支持图片输入（多模态）

**3. 智能参数调整**

温度控制：
- 保守模式：低温度，输出准确、保守
- 平衡模式：中等温度，输出平衡
- 创造性模式：高温度，输出更有创造性

输出长度控制：
- 文章生成任务：自动设置足够的输出长度（确保能生成完整文章）
- 其他任务：使用默认的输出长度限制

**4. 输出格式处理**

- 如果指定了输出格式要求：
  - 自动设置结构化输出模式
  - 自动解析返回的结构化数据
- 如果没有指定输出格式：
  - 直接返回文本内容

**5. 多模态支持**

- 支持图片 URL
- 支持本地图片文件（自动转换为数据格式）
- 图片和文本可以混合输入

### 使用示例

**示例1：生成文章大纲**
- 任务类别：创建类
- 任务类型：大纲生成
- 创造力级别：保守模式（大纲需要准确）
- 输出格式：结构化数据

**示例2：生成文章正文**
- 任务类别：创建类
- 任务类型：内容写作
- 输入数据：主题、项目信息等结构化数据
- 创造力级别：平衡模式（文章需要平衡）
- 自动检测是文章任务，设置足够的输出长度

**示例3：提取结构化数据**
- 任务类别：分析类
- 任务类型：数据提取
- 输入数据：邮件正文
- 输出格式：指定字段的结构化数据
- 创造力级别：保守模式（数据提取需要准确）

---

## Prompt 设计

### 1. 文章生成 Prompt

"""
# 毕业文章生成 Prompt

你是技术社区的资深编辑，要写一篇公众号风格的毕业文章。

## 关键规则（CRITICAL RULES）

### NO LINKS
- **绝对禁止**：不要添加任何链接（后续统一插入）
- 避免链接打断阅读流

### NO FLUFF
- **直接进入主题**：避免 "In this article we will discuss..." 等空话
- 每句话都要有价值
- 不要使用 "Let's dive in" 或 "Without further ado" 等填充句

### NO HALLUCINATIONS
- **严禁编造事实或数据**：只使用提供的数据
- 不编造统计数据、日期、名称等信息
- 不确定的信息明确标注为 "[数据待确认]"
- 如果数据不可用，使用占位符 "[数据不可用]"

### STRICT WORD LIMIT
- **目标字数**：2000-3000 字（这是硬性要求，必须达到）
- **硬性下限**：绝对不少于 2000 字
- **硬性上限**：绝对不超过 3000 字
- **重要**：必须详细展开每个部分，提供充分的细节和说明
- **不要过于简洁**：每个章节都要有足够的篇幅，不能只是简单概括

## 文章主题
Apache HugeGraph 从 Apache 孵化器毕业成为顶级项目（TLP）。

## 写作风格要求

### 段落格式
- **段落简短**：每段 2-3 句，最多不超过 4 句
- **避免大段文字**：大段文字会让读者感到压力

### 列表使用规则
- **尽量避免使用列表**：除非是简短的关键信息（3-5 项）
- **优先使用流畅的散文**：用自然语言描述，而不是 bullet points
- **例外情况**：仅在以下情况使用列表：
  - 简短的功能列表（3-5 项）
  - 价格层级
  - 功能规格对比

### 比较和对比
- **使用表格而非列表**：当需要比较多个项目时，使用 Markdown 表格
- **突出关键信息**：在表格中使用 **粗体** 标记重要信息
- **添加快速结论**：在比较后添加 "> **结论**：..." 格式的总结

### 反 AI 检测
**避免使用以下 AI 检测短语**：
- "In today's world" / "在当今世界"
- "delve into" / "深入探讨"
- "comprehensive guide" / "全面指南"
- "game-changer" / "游戏改变者"
- "unleash" / "释放"
- "elevate" / "提升"
- "streamline" / "简化"
- "leverage" / "利用"
- "robust" / "强大的"
- "cutting-edge" / "前沿的"
- "landscape" / "格局"
- "It is important to note" / "值得注意的是"

**使用自然过渡**：
- "Here's the thing" / "关键点是"
- "But wait" / "但是"
- "The catch?" / "问题在于"

### 语言风格
- **主动语态**：优先使用主动语态
- **专业但易读**：语气专业但保持可读性
- **具体例子**：使用具体、具体的例子，避免抽象概括
- **对话式过渡**：使用自然的对话式过渡

## 内容结构（必须遵循）
1. 标题与引言（包含封面图占位符）
2. 项目简介（HugeGraph 是什么）
3. 孵化历程回顾（2022-2026）
4. 关键成就亮点
   - 社区成长
   - 版本发布
   - 生产应用
   - 生态系统
5. 投票结果总结（含统计表与引用金句）
6. 链接集合占位符
7. 致谢与展望

## 图表占位符
在合适位置插入：
- [COMMUNITY_TREND_CHART]
- [RELEASE_TIMELINE_CHART]
- [VOTE_DISTRIBUTION_CHART]

## 引用金句
从投票邮件中提取正面评价并以引用格式呈现。

## 输出格式
返回 JSON：
{
  "title": "...",
  "meta_description": "...",
  "content": "# 标题\n正文..."
}
"""

### 2. 大纲生成 Prompt

"""
# 大纲生成 Prompt

请生成文章大纲，只包含标题，不要写正文。

## 输出格式（JSON）
{
  "headline_suggestions": ["标题1", "标题2", "标题3"],
  "sections": [
    {"heading": "H2 标题", "notes": "简短说明"},
    {"heading": "H3 标题", "notes": "简短说明"}
  ],
  "keyword_placement": "关键词布局建议"
}
"""

### 3. 引用提取 Prompt

"""
# 引用金句提取 Prompt

从投票邮件正文中提取正面评价、祝贺语或支持性陈述。

## 规则
- 优先选择 IPMC 成员（binding votes）的邮件
- 查找以下类型的表达：
  - 明确祝贺（"Congratulations", "Congrats", "Well done"）
  - 正面评价（"Great work", "Excellent", "Impressive"）
  - 支持性陈述（"I support", "I'm happy to see", "This is great news"）
  - 对项目的积极评价（"Strong community", "Mature project"）
- 如果正文很长，提取最相关的 1-2 句话
- 保持原文，不要改写或总结
- 如果没有合适引用，返回空字符串（不要输出解释或道歉）

## 输出格式
每条引用使用 Markdown blockquote：
> 引用内容 — 姓名
"""

### 4. 投票提取 Prompt（LLM 辅助）

"""
从以下邮件正文中提取投票信息：

邮件正文：
{body[:1000]}  # 限制长度避免 token 过多

请提取以下信息：
1. 投票值：查找 "+1"、"-1"、"+0"（通常位于正文开头）
2. 绑定类型：查找 "binding" 或 "non-binding"（大小写不敏感）
3. 原始文本：包含投票值的一行

如果找不到投票信息，返回 null。

返回 JSON 格式：
{
  "vote_value": "+1" | "-1" | "+0" | null,
  "binding_type": "binding" | "non-binding" | null,
  "raw_text": "原始投票文本"
}
"""

**说明**：此 Prompt 在代码中动态构建，`{body[:1000]}` 会被实际邮件正文内容替换。

### 5. 封面图生成 Prompt

"""
Create a formal and authoritative celebration image for Apache HugeGraph's graduation from Apache Incubator to Top-Level Project status. 

The composition should feature:
- Central placement of the Apache feather logo (classic red Apache brand color #D22128) on the left side
- HugeGraph project logo positioned next to the Apache logo, maintaining brand consistency
- Large, bold headline text in elegant sans-serif font: "Apache HugeGraph Graduates to Top-Level Project" in white or dark text
- Subtitle text below: "2022-2026 | Successfully Incubated" in smaller, refined typography
- Professional color scheme: Apache red (#D22128), deep blue/dark navy for HugeGraph brand colors, clean white backgrounds
- Subtle gradient background transitioning from dark to lighter tones
- Celebration elements: subtle sparkles or light rays suggesting achievement and success
- Corporate, professional aesthetic suitable for official announcements
- Clean, spacious layout with excellent readability
- Dimensions: 1200x630px (16:9 aspect ratio), optimized for social media sharing
- High resolution, print-quality digital art style
- Modern minimalist design with formal presentation suitable for technical community and enterprise audience
"""

**说明**：此 Prompt 硬编码在代码中，用于通义万相 API 生成封面图。
